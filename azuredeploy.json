{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "resourceIndex": {
            "type": "string",
            "metadata": {
                "description": "An index to append to certain resource names to avoid collisions during testing."
            }
        },
        "vmUserName": {
            "type": "string",
            "metadata": {
                "description": "Login user name for the spinnaker VM."
            }
        },
        "vmPassword": {
            "type": "securestring",
            "metadata": {
                "description": "Login password for the spinnaker VM."
            }
        },
        "spnClientId": {
            "type": "securestring",
            "metadata": {
                "description": "Client ID of the Azure AD application that has rights to spinnaker."
            }
        },
        "spnTenantId": {
            "type": "securestring",
            "metadata": {
                "description": "Tenant ID of the Azure AD application that has rights to spinnaker."
            }
        },
        "templateLocation": {
            "type": "string",
            "defaultValue": "https://golivearmstorage.blob.core.windows.net/spinnaker-jenkins",
            "metadata": {
                "description": "Template file location",
                "artifactsBaseUrl": "Base URL of the Publisher Template gallery package"
            }
        },
        "packerResourceGroupName": {
            "type": "string",
            "metadata": {
                "description": "Resource Group containing Packer."
            }
        },
        "packerStorageAccountName": {
            "type": "string",
            "metadata": {
                "description": "Storage account holding Packer assets."
            }
        }
    },
    "variables": {
        "scenarioPrefix": "spinnaker",
        "templateAPIVersion": "2016-09-01",
        "templateBaseUrl": "[concat(parameters('templateLocation'), '/')]",
        "storageAccountName": "[concat('golivespinvhds', parameters('resourceIndex'))]",
        "storageAccountContainerName": "vhds",
        "spinnakerTemplateUrl": "[concat(variables('templateBaseUrl'), 'nested/', 'spinnakerDeploy.json')]",
        "storageTemplateUrl": "[concat(variables('templateBaseUrl'), 'nested/', 'storageDeploy.json')]",
        "vnetTemplateUrl": "[concat(variables('templateBaseUrl'), 'nested/', 'vnetDeploy.json')]",
        "jenkinsTemplateUrl": "[concat(variables('templateBaseUrl'), 'nested/', 'jenkinsDeploy.json')]",
        "vnetName": "[concat(variables('scenarioPrefix'),'Vnet')]",
        "subnet0Name": "[concat(variables('scenarioPrefix'),'Subnet0')]",
        "subnet1Name": "[concat(variables('scenarioPrefix'),'Subnet1')]",
        "subnet2Name": "[concat(variables('scenarioPrefix'),'Subnet2')]",
        "vnetID": "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]",
        "subnet0Ref": "[concat(variables('vnetID'),'/subnets/', variables('subnet0Name'))]"
    },
    "resources": [
        {
            "apiVersion": "[variables('templateAPIVersion')]",
            "type": "Microsoft.Resources/deployments",
            "name": "storage-deployment",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('storageTemplateUrl')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "StorageAccount": {
                        "value": {
                            "name": "[variables('storageAccountName')]",
                            "type": "Standard_LRS"
                        }
                    }
                }
            }
        },
        {
            "apiVersion": "[variables('templateAPIVersion')]",
            "type": "Microsoft.Resources/deployments",
            "name": "vnet-deployment",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('vnetTemplateUrl')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "VirtualNetwork": {
                        "value": {
                            "name": "[variables('vnetName')]",
                            "addressSpace": "10.0.0.0/20",
                            "subnet0Name": "[variables('subnet0Name')]",
                            "subnet1Name": "[variables('subnet1Name')]",
                            "subnet2Name": "[variables('subnet2Name')]",
                            "subnet0AddressPrefix": "10.0.0.0/24",
                            "subnet1AddressPrefix": "10.0.1.0/24",
                            "subnet2AddressPrefix": "10.0.2.0/24"
                        }
                    }
                }
            }
        },
        {
            "apiVersion": "[variables('templateAPIVersion')]",
            "type": "Microsoft.Resources/deployments",
            "name": "spinnaker-deployment",
            "dependsOn": [
                "Microsoft.Resources/deployments/storage-deployment",
                "Microsoft.Resources/deployments/vnet-deployment"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('spinnakerTemplateUrl')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "SpinnakerVM": {
                        "value": {
                            "StorageAccountName": "[variables('storageAccountName')]",
                            "StorageAccountContainerName": "[variables('storageAccountContainerName')]",
                            "dnsPrefix": "[concat('golivespinip', parameters('resourceIndex'))]",
                            "publicIPAddressName": "[concat('spinnakerPublicIp', parameters('resourceIndex'))]",
                            "vmSize": "Standard_D2",
                            "subnet0Ref": "[variables('subnet0Ref')]"
                        }
                    },
                    "Keyvault": {
                        "value": {
                            "name": "[concat('golive', variables('scenarioPrefix'), 'Vault', parameters('resourceIndex'))]",
                            "userName": "[parameters('vmUsername')]",
                            "password": "[parameters('vmPassword')]",
                            "tenantId": "[parameters('spnClientId')]",
                            "clientId": "[parameters('spnTenantId')]",
                            "clientSecret": "",
                            "subscriptionId": "",
                            "resourceGroupName": "[resourceGroup().name]"
                        }
                    },
                    "Packer": {
                        "value": {
                            "resourceGroupName": "[parameters('packerResourceGroupName')]",
                            "storageAccountName": "[parameters('packerStorageAccountName')]"
                        }
                    }
                }
            }
        },
        {
            "apiVersion": "[variables('templateAPIVersion')]",
            "type": "Microsoft.Resources/deployments",
            "name": "jenkins-deployment",
            "dependsOn": [
                "Microsoft.Resources/deployments/storage-deployment",
                "Microsoft.Resources/deployments/vnet-deployment"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('jenkinsTemplateUrl')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "JenkinsVM": {
                        "value": {
                            "StorageAccountName": "[variables('storageAccountName')]",
                            "StorageAccountContainerName": "[variables('storageAccountContainerName')]",
                            "dnsPrefix": "[concat('golivejenkinsip', parameters('resourceIndex'))]",
                            "publicIPAddressName": "[concat('jenkinsPublicIp', parameters('resourceIndex'))]",
                            "vmSize": "Standard_D2",
                            "subnet0Ref": "[variables('subnet0Ref')]"
                        }
                    },
                    "Keyvault": {
                        "value": {
                            "name": "[concat('golive', variables('scenarioPrefix'), 'Vault', parameters('resourceIndex'))]",
                            "userName": "[parameters('vmUsername')]",
                            "password": "[parameters('vmPassword')]",
                            "tenantId": "[parameters('spnClientId')]",
                            "clientId": "[parameters('spnTenantId')]",
                            "clientSecret": "",
                            "subscriptionId": "",
                            "resourceGroupName": "[resourceGroup().name]"
                        }
                    }
                }
            }
        }
    ],
    "outputs": {}
}